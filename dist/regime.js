// Generated by CoffeeScript 1.5.0
(function() {

  this.Regime = {};

}).call(this);
// Generated by CoffeeScript 1.5.0
(function() {
  var Signal,
    __slice = [].slice;

  this.Regime.Signal = Signal = {};

  Signal.listeners = function() {
    var event_name, event_names, listener, listeners, stack, _i, _j, _len, _len1, _ref, _ref1;
    listeners = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
    stack = [];
    for (_i = 0, _len = listeners.length; _i < _len; _i++) {
      _ref = listeners[_i], event_names = _ref[0], listener = _ref[1];
      _ref1 = event_names.split(' ');
      for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
        event_name = _ref1[_j];
        stack.push([event_name, listener]);
      }
    }
    return stack;
  };

  Signal.add_listeners = function() {
    var additional_listeners, listeners;
    listeners = arguments[0], additional_listeners = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    return listeners.concat(Signal.listeners.apply(Signal, additional_listeners));
  };

  Signal.emit = function() {
    var args, event_name, listener, listeners, signal, _i, _len, _ref;
    listeners = arguments[0], signal = arguments[1], args = 3 <= arguments.length ? __slice.call(arguments, 2) : [];
    for (_i = 0, _len = listeners.length; _i < _len; _i++) {
      _ref = listeners[_i], event_name = _ref[0], listener = _ref[1];
      if (event_name === '' || event_name === signal) {
        listener.apply(this, [signal].concat(args));
      }
    }
  };

}).call(this);
// Generated by CoffeeScript 1.5.0
(function() {
  var Controller, Signal, collect_path, is_scalar, merge, paths_and_scalar_values,
    __slice = [].slice;

  this.Regime.Controller = Controller = {};

  Signal = this.Regime.Signal;

  Controller.create = function(state, listeners) {
    if (state == null) {
      state = {};
    }
    if (listeners == null) {
      listeners = [];
    }
    return {
      state: state,
      listeners: listeners
    };
  };

  Controller.push_listeners = function(controller, listeners) {
    return Controller.create(controller.state, listeners);
  };

  merge = function() {
    var k, m, mixins, obj, v, _i, _len;
    obj = arguments[0], mixins = 2 <= arguments.length ? __slice.call(arguments, 1) : [];
    for (_i = 0, _len = mixins.length; _i < _len; _i++) {
      m = mixins[_i];
      for (k in m) {
        v = m[k];
        obj[k] = v;
      }
    }
    return obj;
  };

  collect_path = function(obj, path) {
    var p, path_obj, _i, _len, _ref;
    path_obj = merge({}, obj);
    _ref = path.split('.');
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      p = _ref[_i];
      path_obj = path_obj != null ? path_obj[p] : void 0;
    }
    return path_obj;
  };

  Controller.emit_state_path = function(controller, path, state) {
    if (state == null) {
      state = collect_path(controller.state, path);
      if (state == null) {
        return;
      }
    }
    Signal.emit(controller.listeners, path, state);
  };

  Controller.emit_state = function(controller, state) {
    var path, path_state, _i, _len, _ref, _ref1;
    _ref = paths_and_scalar_values(state);
    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
      _ref1 = _ref[_i], path = _ref1[0], path_state = _ref1[1];
      Controller.emit_state_path(controller, path, path_state);
    }
  };

  is_scalar = function(v) {
    switch (typeof v) {
      case 'string':
      case 'number':
      case 'boolean':
        return true;
    }
    if (v == null) {
      return true;
    }
    return false;
  };

  paths_and_scalar_values = function(obj, prefix) {
    var k, p, path, v;
    if (prefix == null) {
      prefix = '';
    }
    p = [];
    for (k in obj) {
      v = obj[k];
      path = "" + prefix + k;
      p.push([path, v]);
      if (!is_scalar(v)) {
        p = p.concat(paths_and_scalar_values(v, "" + path + "."));
      }
    }
    return p;
  };

  Controller.replace_state = function(controller, state) {
    controller.state = state;
    Controller.emit_state(controller, state);
    return controller;
  };

  Controller.merge_state = function(controller, state) {
    merge(controller.state, state);
    Controller.emit_state(controller, state);
    return controller;
  };

  Controller.add_listener = function(controller, path, fn) {
    var listeners;
    listeners = Signal.add_listeners(controller.listeners, [
      path, function(_, state) {
        return fn(state);
      }
    ]);
    controller = Controller.push_listeners(controller, listeners);
    Controller.emit_state_path(controller, path);
    return controller;
  };

  Controller.create_stateful = function() {
    var controller;
    controller = Controller.create();
    return {
      state: function(path) {
        if (path == null) {
          return merge({}, controller.state);
        }
        return collect_path(controller.state, path);
      },
      replace_state: function(state) {
        controller = Controller.replace_state(controller, state);
      },
      merge_state: function(state) {
        controller = Controller.merge_state(controller, state);
      },
      add_listener: function(path, fn) {
        controller = Controller.add_listener(controller, path, fn);
      }
    };
  };

}).call(this);
